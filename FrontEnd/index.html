<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            width: min(90vw, 450px);
            min-height: 600px;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 2rem;
            text-align: center;
            color: white;
            position: relative;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .content {
            padding: 2rem;
            position: relative;
        }

        /* Navigation Pills */
        .nav-pills {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 2rem;
        }

        .nav-pill {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            user-select: none;
        }

        .nav-pill.active {
            background: white;
            color: #4facfe;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Form Styles */
        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fff;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .form-group input.error {
            border-color: #e74c3c;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            margin-bottom: 1rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
        }

        .btn-google {
            background: #fff;
            color: #333;
            border: 2px solid #e9ecef;
            margin-bottom: 1rem;
        }

        .btn-google:hover {
            border-color: #4285f4;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.15);
        }

        .google-icon {
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, #4285f4, #34a853, #fbbc05, #ea4335);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Divider */
        .divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            color: #6c757d;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e9ecef;
        }

        .divider span {
            padding: 0 1rem;
            font-size: 0.9rem;
        }

        /* User Info Section */
        .user-info {
            display: none;
        }

        .user-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 1rem;
        }

        .user-details h3 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1.3rem;
        }

        .user-details p {
            color: #666;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-sm {
            padding: 10px 16px;
            font-size: 0.9rem;
        }

        .token-info {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.8rem;
        }

        .token-info h4 {
            color: #2d5a2d;
            margin-bottom: 0.5rem;
        }

        .token-display {
            background: white;
            border-radius: 8px;
            padding: 0.5rem;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            color: #666;
            border: 1px solid #ddd;
            max-height: 100px;
            overflow-y: auto;
        }

        /* Loading and Messages */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        .message.error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
        }

        .message.success {
            background: #efe;
            border: 1px solid #cfc;
            color: #3c3;
        }

        /* API Test Section */
        .api-test {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #eee;
        }

        .api-test h4 {
            margin-bottom: 1rem;
            color: #333;
        }

        .api-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .api-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .api-btn:hover {
            background: #f8f9fa;
            border-color: #4facfe;
        }

        .api-response {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #333;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .api-buttons {
                grid-template-columns: 1fr;
            }
        }

        /* Form validation */
        .form-group.error input {
            border-color: #e74c3c;
        }

        .form-group .error-message {
            color: #e74c3c;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .form-group.error .error-message {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Restaurant System</h1>
            <p>Gesti√≥n de Restaurante Moderna</p>
        </div>

        <div class="content">
            <!-- Navigation Pills -->
            <div class="nav-pills" id="navPills">
                <div class="nav-pill active" data-section="login">Iniciar Sesi√≥n</div>
                <div class="nav-pill" data-section="register">Registrarse</div>
            </div>

            <!-- Loading Section -->
            <div class="loading" id="loadingSection">
                <div class="spinner"></div>
                <p>Procesando...</p>
            </div>

            <!-- Messages -->
            <div class="message error" id="errorMessage"></div>
            <div class="message success" id="successMessage"></div>

            <!-- Login Section -->
            <div class="form-section active" id="loginSection">
                <!-- Error espec√≠fico de login -->
                <div class="message error" id="loginErrorMessage" style="margin-bottom: 1rem;"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Correo Electr√≥nico</label>
                        <input type="email" id="loginEmail" name="email" required>
                        <div class="error-message">Ingresa un correo v√°lido</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">Contrase√±a</label>
                        <input type="password" id="loginPassword" name="password" required>
                        <div class="error-message">La contrase√±a es obligatoria</div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="loginSubmitBtn">
                        <span id="loginBtnText">Iniciar Sesi√≥n</span>
                        <div class="spinner" id="loginSpinner" style="display: none; width: 20px; height: 20px; margin-left: 10px;"></div>
                    </button>
                </form>

                <div class="divider">
                    <span>o contin√∫a con</span>
                </div>

                <button class="btn btn-google" id="googleLoginBtn">
                    <div class="google-icon">G</div>
                    <span>Continuar con Google</span>
                </button>
            </div>

            <!-- Register Section -->
            <div class="form-section" id="registerSection">
                <!-- Error espec√≠fico de registro -->
                <div class="message error" id="registerErrorMessage" style="margin-bottom: 1rem;"></div>
                
                <form id="registerForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="registerFirstName">Nombre</label>
                            <input type="text" id="registerFirstName" name="firstName" required>
                            <div class="error-message">El nombre es obligatorio</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="registerLastName">Apellido</label>
                            <input type="text" id="registerLastName" name="lastName" required>
                            <div class="error-message">El apellido es obligatorio</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="registerUsername">Nombre de Usuario</label>
                        <input type="text" id="registerUsername" name="username" required>
                        <div class="error-message">El nombre de usuario es obligatorio</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="registerEmail">Correo Electr√≥nico</label>
                        <input type="email" id="registerEmail" name="email" required>
                        <div class="error-message">Ingresa un correo v√°lido</div>
                    </div>

                    <div class="form-group">
                        <label for="registerPhone">Tel√©fono (Opcional)</label>
                        <input type="tel" id="registerPhone" name="phone">
                    </div>
                    
                    <div class="form-group">
                        <label for="registerPassword">Contrase√±a</label>
                        <input type="password" id="registerPassword" name="password" required>
                        <div class="error-message">M√≠nimo 8 caracteres, una may√∫scula, una min√∫scula, un n√∫mero y un car√°cter especial</div>
                    </div>

                    <div class="form-group">
                        <label for="registerConfirmPassword">Confirmar Contrase√±a</label>
                        <input type="password" id="registerConfirmPassword" name="confirmPassword" required>
                        <div class="error-message">Las contrase√±as no coinciden</div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="registerSubmitBtn">
                        <span id="registerBtnText">Crear Cuenta</span>
                        <div class="spinner" id="registerSpinner" style="display: none; width: 20px; height: 20px; margin-left: 10px;"></div>
                    </button>
                </form>

                <div class="divider">
                    <span>o reg√≠strate con</span>
                </div>

                <button class="btn btn-google" id="googleRegisterBtn">
                    <div class="google-icon">G</div>
                    <span>Registrarse con Google</span>
                </button>
            </div>

            <!-- User Info Section -->
            <div class="user-info" id="userInfoSection">
                <div class="user-card">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <h3 id="userName">Usuario</h3>
                        <p><strong>Email:</strong> <span id="userEmail">-</span></p>
                        <p><strong>Username:</strong> <span id="userUsername">-</span></p>
                        <p><strong>Roles:</strong> <span id="userRoles">-</span></p>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary btn-sm" id="testApiBtn">Probar API</button>
                    <button class="btn btn-secondary btn-sm" id="logoutBtn">Cerrar Sesi√≥n</button>
                </div>

                <!-- Token Info -->
                <div class="token-info">
                    <h4>Token JWT:</h4>
                    <div class="token-display" id="tokenDisplay">No hay token</div>
                </div>

                <!-- API Test Section -->
                <div class="api-test" id="apiTestSection" style="display: none;">
                    <h4>Probar Endpoints de la API</h4>
                    <div class="api-buttons">
                        <button class="api-btn" onclick="testApi('/api/menu')">Obtener Men√∫</button>
                        <button class="api-btn" onclick="testApi('/api/clients')">Obtener Clientes</button>
                        <button class="api-btn" onclick="testApi('/api/orders')">Obtener √ìrdenes</button>
                        <button class="api-btn" onclick="testApi('/api/employees')">Obtener Empleados</button>
                    </div>
                    <div class="api-response" id="apiResponse"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.google.com/recaptcha/api.js?render=6Lcy8x4rAAAAAKSfqVFXEkhNz_IsFIb_iCn5qOwy"></script>
    <script>
        // Configuraci√≥n
        const API_BASE_URL = 'http://localhost:8080';
        const OAUTH2_URL = `${API_BASE_URL}/oauth2/authorize/google`;
        
        // Variables globales
        let currentToken = null;
        let currentUser = null;

        // Elementos DOM
        const navPills = document.querySelectorAll('.nav-pill');
        const formSections = document.querySelectorAll('.form-section');
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const userInfoSection = document.getElementById('userInfoSection');
        const loadingSection = document.getElementById('loadingSection');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        
        // Mensajes espec√≠ficos de cada formulario
        const loginErrorMessage = document.getElementById('loginErrorMessage');
        const registerErrorMessage = document.getElementById('registerErrorMessage');
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');
        const registerSubmitBtn = document.getElementById('registerSubmitBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const registerBtnText = document.getElementById('registerBtnText');
        const loginSpinner = document.getElementById('loginSpinner');
        const registerSpinner = document.getElementById('registerSpinner');

        // Forms
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        // Buttons
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const googleRegisterBtn = document.getElementById('googleRegisterBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const testApiBtn = document.getElementById('testApiBtn');
        const apiTestSection = document.getElementById('apiTestSection');

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Aplicaci√≥n iniciada');
            
            // Verificar si el usuario ya est√° autenticado
            checkExistingAuth();
            
            // Configurar navegaci√≥n
            setupNavigation();
            
            // Configurar eventos de formularios
            setupForms();
            
            // Configurar botones OAuth2
            googleLoginBtn.addEventListener('click', handleGoogleAuth);
            googleRegisterBtn.addEventListener('click', handleGoogleAuth);
            logoutBtn.addEventListener('click', handleLogout);
            testApiBtn.addEventListener('click', toggleApiTest);

            // Verificar si hay un token en la URL (despu√©s de OAuth2)
            checkForTokenInUrl();
        });

        // Verificar si el usuario ya est√° autenticado
        function checkExistingAuth() {
            const existingToken = localStorage.getItem('authToken');
            const existingUser = localStorage.getItem('currentUser');
            
            if (existingToken && existingUser) {
                try {
                    // Verificar si el token a√∫n es v√°lido (no expirado)
                    const payload = existingToken.split('.')[1];
                    const decoded = JSON.parse(atob(payload));
                    const currentTime = Date.now() / 1000;
                    
                    if (decoded.exp > currentTime) {
                        // Token v√°lido, redirigir al dashboard
                        console.log('Usuario ya autenticado, redirigiendo al dashboard...');
                        showSuccess('Ya tienes una sesi√≥n activa. Redirigiendo...');
                        setTimeout(() => {
                            window.location.href = 'html/sistema de gestion/dashboard.html';
                        }, 1000);
                        return;
                    } else {
                        // Token expirado, limpiar localStorage
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                        console.log('Token expirado, se requiere nueva autenticaci√≥n');
                    }
                } catch (error) {
                    // Token inv√°lido, limpiar localStorage
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('currentUser');
                    console.error('Token inv√°lido en localStorage:', error);
                }
            }
        }

        // Navegaci√≥n entre secciones
        function setupNavigation() {
            navPills.forEach(pill => {
                pill.addEventListener('click', () => {
                    const section = pill.dataset.section;
                    switchSection(section);
                });
            });
        }

        function switchSection(section) {
            // Limpiar errores de ambas secciones
            hideLoginError();
            hideRegisterError();

            // Actualizar pills
            navPills.forEach(pill => {
                pill.classList.toggle('active', pill.dataset.section === section);
            });

            // Mostrar secci√≥n correspondiente
            formSections.forEach(form => {
                form.classList.remove('active');
            });

            if (section === 'login') {
                loginSection.classList.add('active');
            } else if (section === 'register') {
                registerSection.classList.add('active');
            }
        }

        // Configurar formularios
        function setupForms() {
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
        }

        // Manejo de login manual
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            // Limpiar errores previos
            hideLoginError();

            if (!validateLoginForm(email, password)) {
                return;
            }

            // Mostrar loading en el bot√≥n
            setLoginLoading(true);

            try {
                // Obtener token reCAPTCHA
                const recaptchaToken = await getRecaptchaToken('login');
                
                const response = await fetch(`${API_BASE_URL}/api/auth/signin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usernameOrEmail: email,
                        password: password,
                        recaptchaToken: recaptchaToken
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    handleAuthSuccess(data);
                } else {
                    // Mostrar error espec√≠fico en el formulario de login
                    showLoginError(data.message || 'Usuario o contrase√±a incorrectos');
                }
            } catch (error) {
                console.error('Error:', error);
                showLoginError('Error de conexi√≥n. Verifica que el servidor est√© funcionando.');
            } finally {
                setLoginLoading(false);
            }
        }

        // Manejo de registro manual
        async function handleRegister(e) {
            e.preventDefault();
            
            const formData = {
                firstName: document.getElementById('registerFirstName').value,
                lastName: document.getElementById('registerLastName').value,
                username: document.getElementById('registerUsername').value,
                email: document.getElementById('registerEmail').value,
                phone: document.getElementById('registerPhone').value,
                password: document.getElementById('registerPassword').value,
                confirmPassword: document.getElementById('registerConfirmPassword').value
            };

            // Limpiar errores previos
            hideRegisterError();

            if (!validateRegisterForm(formData)) {
                return;
            }

            // Mostrar loading en el bot√≥n
            setRegisterLoading(true);

            try {
                // Obtener token reCAPTCHA
                const recaptchaToken = await getRecaptchaToken('register');
                
                const response = await fetch(`${API_BASE_URL}/api/auth/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        firstName: formData.firstName,
                        lastName: formData.lastName,
                        username: formData.username,
                        email: formData.email,
                        phone: formData.phone,
                        password: formData.password,
                        recaptchaToken: recaptchaToken
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess('¬°Cuenta creada exitosamente! Ahora puedes iniciar sesi√≥n.');
                    switchSection('login');
                    registerForm.reset();
                } else {
                    // Mostrar error espec√≠fico en el formulario de registro
                    showRegisterError(data.message || 'Error al crear la cuenta');
                }
            } catch (error) {
                console.error('Error:', error);
                showRegisterError('Error de conexi√≥n. Verifica que el servidor est√© funcionando.');
            } finally {
                setRegisterLoading(false);
            }
        }

        // Funci√≥n para obtener token reCAPTCHA con fallback
        async function getRecaptchaToken(action) {
            try {
                // Verificar si grecaptcha est√° disponible
                if (typeof grecaptcha === 'undefined') {
                    console.warn('reCAPTCHA no est√° disponible, usando modo de desarrollo');
                    return 'dev_mode_token';
                }

                // Usar la site key p√∫blica correcta
                const token = await grecaptcha.execute('6Lcy8x4rAAAAAKSfqVFXEkhNz_IsFIb_iCn5qOwy', {
                    action: action
                });
                console.log('‚úÖ Token reCAPTCHA obtenido:', token.substring(0, 20) + '...');
                return token;
            } catch (error) {
                console.error('‚ùå Error obteniendo token reCAPTCHA:', error);
                
                // Fallback: retornar un token de desarrollo
                console.warn('üîß Usando modo de desarrollo sin reCAPTCHA');
                return 'dev_mode_token';
            }
        }

        // Funci√≥n para obtener token reCAPTCHA
        async function getRecaptchaToken(action) {
            try {
                // Usar la site key de tu configuraci√≥n
                const token = await grecaptcha.execute('6Lcy8x4rAAAAAKSfqVFXEkhNz_IsFIb_iCn5qOwy', {
                    action: action
                });
                console.log('Token reCAPTCHA obtenido:', token.substring(0, 20) + '...');
                return token;
            } catch (error) {
                console.error('Error obteniendo token reCAPTCHA:', error);
                throw new Error('Error de verificaci√≥n de seguridad');
            }
        }
        function validateLoginForm(email, password) {
            let isValid = true;

            // Validar email
            const emailField = document.getElementById('loginEmail').parentElement;
            if (!email || !isValidEmail(email)) {
                emailField.classList.add('error');
                isValid = false;
            } else {
                emailField.classList.remove('error');
            }

            // Validar password
            const passwordField = document.getElementById('loginPassword').parentElement;
            if (!password) {
                passwordField.classList.add('error');
                isValid = false;
            } else {
                passwordField.classList.remove('error');
            }

            return isValid;
        }

        function validateRegisterForm(formData) {
            let isValid = true;

            // Validar nombre
            const firstNameField = document.getElementById('registerFirstName').parentElement;
            if (!formData.firstName || formData.firstName.length < 2) {
                firstNameField.classList.add('error');
                isValid = false;
            } else {
                firstNameField.classList.remove('error');
            }

            // Validar apellido
            const lastNameField = document.getElementById('registerLastName').parentElement;
            if (!formData.lastName || formData.lastName.length < 2) {
                lastNameField.classList.add('error');
                isValid = false;
            } else {
                lastNameField.classList.remove('error');
            }

            // Validar username
            const usernameField = document.getElementById('registerUsername').parentElement;
            if (!formData.username || formData.username.length < 3) {
                usernameField.classList.add('error');
                isValid = false;
            } else {
                usernameField.classList.remove('error');
            }

            // Validar email
            const emailField = document.getElementById('registerEmail').parentElement;
            if (!formData.email || !isValidEmail(formData.email)) {
                emailField.classList.add('error');
                isValid = false;
            } else {
                emailField.classList.remove('error');
            }

            // Validar password
            const passwordField = document.getElementById('registerPassword').parentElement;
            if (!formData.password || !isValidPassword(formData.password)) {
                passwordField.classList.add('error');
                isValid = false;
            } else {
                passwordField.classList.remove('error');
            }

            // Validar confirmaci√≥n de password
            const confirmPasswordField = document.getElementById('registerConfirmPassword').parentElement;
            if (formData.password !== formData.confirmPassword) {
                confirmPasswordField.classList.add('error');
                isValid = false;
            } else {
                confirmPasswordField.classList.remove('error');
            }

            return isValid;
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function isValidPassword(password) {
            // M√≠nimo 8 caracteres, una may√∫scula, una min√∫scula, un n√∫mero y un car√°cter especial
            return /^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%^&+=])(?=\S+$).{8,}$/.test(password);
        }

        // OAuth2 con Google
        function handleGoogleAuth(e) {
            e.preventDefault();
            console.log('Iniciando autenticaci√≥n con Google...');
            
            showLoading();
            
            // Redirigir a Google OAuth2
            window.location.href = OAUTH2_URL;
        }

        // Verificar token en URL (despu√©s de OAuth2)
        function checkForTokenInUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const auth = urlParams.get('auth');
            const error = urlParams.get('error');

            if (error) {
                console.error('Error en OAuth2:', error);
                showError('Error en la autenticaci√≥n: ' + decodeURIComponent(error));
                return;
            }

            if (token && auth === 'success') {
                console.log('Token encontrado en URL:', token.substring(0, 20) + '...');
                handleTokenReceived(token);
                
                // Limpiar la URL sin recargar la p√°gina
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }
        }

        // Manejar token recibido (OAuth2 o login manual)
        async function handleTokenReceived(token) {
            try {
                console.log('Procesando token recibido...');
                currentToken = token;
                
                // Decodificar JWT para obtener informaci√≥n b√°sica
                let userInfo = decodeJWT(token);
                
                // Si la informaci√≥n del JWT est√° incompleta, obtener del backend
                if (!userInfo || userInfo.email === 'No disponible' || userInfo.firstName === 'Usuario') {
                    console.log('Informaci√≥n incompleta en JWT, obteniendo del backend...');
                    try {
                        const additionalInfo = await fetchUserInfoFromBackend(token);
                        if (additionalInfo) {
                            // Combinar informaci√≥n del JWT con la del backend
                            userInfo = {
                                ...userInfo,
                                ...additionalInfo
                            };
                        }
                    } catch (error) {
                        console.warn('No se pudo obtener informaci√≥n adicional del backend:', error);
                    }
                }
                
                if (userInfo) {
                    currentUser = userInfo;
                    
                    // Guardar token y usuario en localStorage para el dashboard
                    localStorage.setItem('authToken', token);
                    localStorage.setItem('currentUser', JSON.stringify(userInfo));
                    
                    // Mostrar mensaje de √©xito
                    showSuccess('¬°Autenticaci√≥n exitosa! Redirigiendo al dashboard...');
                    
                    // Redirigir al dashboard despu√©s de un breve delay
                    setTimeout(() => {
                        window.location.href = 'html/sistema de gestion/dashboard.html';
                    }, 1500);
                } else {
                    throw new Error('No se pudo obtener la informaci√≥n del usuario');
                }
                
            } catch (error) {
                console.error('Error al procesar el token:', error);
                showError('Error al procesar la autenticaci√≥n: ' + error.message);
            }
        }

        // Obtener informaci√≥n adicional del usuario desde el backend
        async function fetchUserInfoFromBackend(token) {
            try {
                // Intentar obtener el perfil del usuario actual
                const response = await fetch(`${API_BASE_URL}/api/user/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    console.log('Informaci√≥n del usuario obtenida del backend:', userData);
                    return {
                        username: userData.username,
                        email: userData.email,
                        firstName: userData.firstName,
                        lastName: userData.lastName,
                        roles: userData.roles || ['ROLE_CLIENT']
                    };
                }
            } catch (error) {
                console.warn('Error al obtener informaci√≥n del backend:', error);
            }
            return null;
        }

        // Manejar respuesta de autenticaci√≥n exitosa
        function handleAuthSuccess(response) {
            if (response.token) {
                handleTokenReceived(response.token);
            } else {
                showError('No se recibi√≥ token de autenticaci√≥n');
            }
        }

        // Decodificar JWT - Versi√≥n mejorada
        function decodeJWT(token) {
            try {
                const payload = token.split('.')[1];
                const decoded = JSON.parse(atob(payload));
                
                console.log('JWT decodificado:', decoded); // Para debug
                
                // El JWT puede tener diferentes estructuras seg√∫n el tipo de login
                let email = decoded.email || decoded.sub || 'No disponible';
                let username = decoded.username || decoded.preferred_username || decoded.sub || 'Usuario';
                let firstName = decoded.given_name || decoded.firstName || 'Usuario';
                let lastName = decoded.family_name || decoded.lastName || '';
                
                // Si el subject parece ser un email (contiene @), entonces es OAuth2
                if (decoded.sub && decoded.sub.includes('@')) {
                    email = decoded.sub;
                    username = decoded.sub.split('@')[0];
                    
                    // Para OAuth2, extraer nombre del email
                    const emailPart = email.split('@')[0];
                    if (emailPart.includes('.')) {
                        const parts = emailPart.split('.');
                        firstName = parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
                        lastName = parts[1] ? parts[1].charAt(0).toUpperCase() + parts[1].slice(1) : '';
                    } else {
                        firstName = emailPart.charAt(0).toUpperCase() + emailPart.slice(1);
                    }
                }
                // Si el subject NO es un email, entonces es login manual
                else {
                    // Para login manual, el subject es el username
                    username = decoded.sub;
                    // Buscar el email en otros campos
                    email = decoded.email || decoded.mail || 'No disponible';
                    
                    // Para login manual, usar datos del registro si est√°n disponibles
                    firstName = decoded.firstName || decoded.given_name || username;
                    lastName = decoded.lastName || decoded.family_name || '';
                }
                
                return {
                    username: username,
                    email: email,
                    firstName: firstName,
                    lastName: lastName,
                    roles: decoded.roles || decoded.authorities || ['ROLE_CLIENT']
                };
            } catch (error) {
                console.error('Error al decodificar JWT:', error);
                return {
                    username: 'Usuario',
                    email: 'No disponible',
                    firstName: 'Usuario',
                    lastName: '',
                    roles: ['ROLE_CLIENT']
                };
            }
        }

        // Mostrar informaci√≥n del usuario
        function displayUserInfo(userInfo) {
            console.log('Mostrando informaci√≥n del usuario:', userInfo);
            
            document.getElementById('userName').textContent = 
                `${userInfo.firstName || 'Usuario'} ${userInfo.lastName || ''}`.trim();
            document.getElementById('userEmail').textContent = userInfo.email || 'No disponible';
            document.getElementById('userUsername').textContent = userInfo.username || 'No disponible';
            document.getElementById('userRoles').textContent = 
                Array.isArray(userInfo.roles) ? userInfo.roles.join(', ') : (userInfo.roles || 'ROLE_CLIENT');
            
            // Actualizar avatar
            const avatar = document.getElementById('userAvatar');
            avatar.textContent = (userInfo.firstName || 'U')[0].toUpperCase();
            
            // Mostrar token
            document.getElementById('tokenDisplay').textContent = currentToken;
            
            // Cambiar a vista de usuario
            showUserInfo();
        }

        // Cerrar sesi√≥n
        function handleLogout() {
            console.log('Cerrando sesi√≥n...');
            
            // Limpiar datos de memoria
            currentToken = null;
            currentUser = null;
            
            // Limpiar localStorage
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            
            // Ocultar secci√≥n de API test
            apiTestSection.style.display = 'none';
            
            // Volver a login
            showForms();
            showSuccess('Sesi√≥n cerrada correctamente');
        }

        // Probar API
        function toggleApiTest() {
            const isVisible = apiTestSection.style.display !== 'none';
            apiTestSection.style.display = isVisible ? 'none' : 'block';
        }

        async function testApi(endpoint) {
            if (!currentToken) {
                showError('No hay token disponible para la prueba');
                return;
            }

            const responseDiv = document.getElementById('apiResponse');
            responseDiv.style.display = 'block';
            responseDiv.textContent = 'Cargando...';

            try {
                console.log(`Probando endpoint: ${endpoint}`);
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.text();
                
                if (response.ok) {
                    try {
                        const jsonData = JSON.parse(data);
                        responseDiv.textContent = `Status: ${response.status}\nResponse:\n${JSON.stringify(jsonData, null, 2)}`;
                    } catch {
                        responseDiv.textContent = `Status: ${response.status}\nResponse:\n${data}`;
                    }
                } else {
                    responseDiv.textContent = `Error ${response.status}:\n${data}`;
                }
                
            } catch (error) {
                console.error('Error en prueba de API:', error);
                responseDiv.textContent = `Error: ${error.message}`;
            }
        }

        // Funciones de UI espec√≠ficas para login
        function showLoginError(message) {
            loginErrorMessage.textContent = message;
            loginErrorMessage.style.display = 'block';
        }

        function hideLoginError() {
            loginErrorMessage.style.display = 'none';
        }

        function setLoginLoading(loading) {
            if (loading) {
                loginBtnText.textContent = 'Iniciando sesi√≥n...';
                loginSpinner.style.display = 'inline-block';
                loginSubmitBtn.disabled = true;
            } else {
                loginBtnText.textContent = 'Iniciar Sesi√≥n';
                loginSpinner.style.display = 'none';
                loginSubmitBtn.disabled = false;
            }
        }

        // Funciones de UI espec√≠ficas para registro
        function showRegisterError(message) {
            registerErrorMessage.textContent = message;
            registerErrorMessage.style.display = 'block';
        }

        function hideRegisterError() {
            registerErrorMessage.style.display = 'none';
        }

        function setRegisterLoading(loading) {
            if (loading) {
                registerBtnText.textContent = 'Creando cuenta...';
                registerSpinner.style.display = 'inline-block';
                registerSubmitBtn.disabled = true;
            } else {
                registerBtnText.textContent = 'Crear Cuenta';
                registerSpinner.style.display = 'none';
                registerSubmitBtn.disabled = false;
            }
        }

        // Funciones de UI
        function showForms() {
            hideAll();
            document.getElementById('navPills').style.display = 'flex';
            switchSection('login');
        }

        function showLoading() {
            hideAll();
            loadingSection.style.display = 'block';
        }

        function hideLoading() {
            loadingSection.style.display = 'none';
        }

        function showUserInfo() {
            hideAll();
            userInfoSection.style.display = 'block';
        }

        function hideAll() {
            document.getElementById('navPills').style.display = 'none';
            formSections.forEach(section => section.style.display = 'none');
            loadingSection.style.display = 'none';
            userInfoSection.style.display = 'none';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }

        // Manejar errores globales
        window.addEventListener('error', function(e) {
            console.error('Error global:', e.error);
            showError('Ha ocurrido un error inesperado');
        });
    </script>
</body>
</html>